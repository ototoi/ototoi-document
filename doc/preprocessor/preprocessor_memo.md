#Cプリプロセッサ動作メモ

##本文書について
Cプリプロセッサ動作を個人的メモを記述するものである。

##コメントは削除されるのか？
- デフォルトではコメントは削除される。
- オプションでコメントを削除しないモードが存在する。
  - gccでは`-C`を付ける。`gcc -E -C target.c`

##マクロ名として許されるのは？
- マクロ名はCの識別子によって構成される。
  - 最初の一文字目は`アルファベット`か`_`、２文字目以降は`アルファベット`か`_`か`数字`
  - `([a-zA-Z]|_)+([a-zA-Z]|_|[0-9])*`
- マクロ名にCの識別子以外の名前をつけようとするとエラー
```
#define 1M(x) x  //エラー
#define M2(x) x  //正しい
#define _M3(x) x  //正しい
#define +M4(x) x  //エラー
```

##マクロの再定義
- マクロは同じ名前で再定義すると、警告をだすが再定義可能
- マクロの再定義で、警告を出さないモードが存在
  -  gccでは`-Wmacro-redefined`を付ける。`gcc -E -Wmacro-redefined target.c`

##マクロはいつ展開されるのか
- ディレクティブ行は展開されない
  - あらかじめ展開するなどしない（実際に使用されるまで再定義される可能性があるため） 
- コメント中は展開されない

```
#define M1(x) x  
#define M2(x) M1(x)       //この時点では展開されない:#xではない
#define M1(x) #x          //再定義 

M1(1);        //展開される:"1";
//M1(1);      //展開されない://M1(1);
/*M1(1);*/    //展開されない:/*M1(1);*/
```

##マクロの再帰はされるのか
- マクロ展開は自己再帰展開されない
  - 一度展開されたマクロは再帰的にマクロを展開する際、HS(Hide Set)に登録される。
```
#define M1(x) M3(x)   //
#define M2(x) M1(x)   //
#define M3(x) M2(x)   //
#define M4(x) M3(x)   //

M3(1);                //M3(1); 
M3(1);                //M3(1);
M4(1);                //M3(1);M4を展開するとき、M3を展開したためM1にてM3が展開されない
```
  
##`#`による文字列化
- `#`を関数マクロの定義部の変数の前につけるとその変数の中身を文字列化する。
- `#`を関数マクロの定義部の変数以外につけるとエラーとなる。
```
#define M1(x) #x     //正しい
#define M2(#x) x     //エラー：宣言部の変数に#をつけている
#define M3(x) x #2   //エラー：定義部の変数以外に#をつけている

int main(){
    printf(#1);   //エラー：関数マクロ以外に#をつけている
    return 0;
}
```

##`#`による文字列化はいつ動作するか
- マクロ展開中に`#`による文字列化が起こる
- 文字列化 > トークン結合 > マクロ展開の順

```
#define M1(x) 1     
#define M2(x) #x     

M2(M1(1))         //"M1(1)" : "1"ではない
```

##`##`によるトークン結合
- マクロの定義部で記述可能

```
#define M1(x) x ## 1    //成功:x1
#define M2(x) M ## 1(x)    //成功:x1
#define M3(x ## 1) x1   //エラー
```


